<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡€å£“å¿ƒè·³å³æ™‚ç›£æ¸¬å·¥å…·</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­å®šå­—é«”ç‚º Interï¼Œç¢ºä¿ä¸­æ–‡å­—é«”æ¸…æ™° -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f7f9fb;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border-radius: 1rem;
        }
        input[type="number"], select {
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            width: 100%;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // å…¨åŸŸè®Šæ•¸åˆå§‹åŒ–
        let db;
        let auth;
        let userId = 'loading'; // é è¨­ç‹€æ…‹
        const readingsRef = document.getElementById('readings-list');
        const summaryCard = document.getElementById('summary-card');
        const currentUserIdDisplay = document.getElementById('current-user-id');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Firestore è·¯å¾‘å®šç¾©
        const getCollectionPath = (uid) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return `/artifacts/${appId}/users/${uid}/bp_readings`;
        };

        // Firebase åˆå§‹åŒ–èˆ‡é©—è­‰
        const initFirebase = async () => {
            try {
                // æª¢æŸ¥ä¸¦ä½¿ç”¨å…¨åŸŸè®Šæ•¸
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase Configuration is missing.");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // è¨­å®š Firestore æ—¥èªŒç´šåˆ¥
                setLogLevel('error');

                // å˜—è©¦ä½¿ç”¨è‡ªè¨‚ Token ç™»å…¥ï¼Œå¦‚æœæ²’æœ‰å‰‡åŒ¿åç™»å…¥
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // è¨­ç½®èº«ä»½é©—è­‰ç‹€æ…‹ç›£è½å™¨
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        currentUserIdDisplay.textContent = `ä½¿ç”¨è€… ID: ${userId}`;
                        // é–‹å§‹ç›£è½è³‡æ–™
                        setupDataListener(userId);
                        loadingSpinner.classList.add('hidden');
                        document.getElementById('input-form').classList.remove('hidden');
                    } else {
                        userId = crypto.randomUUID();
                        currentUserIdDisplay.textContent = `åŒ¿å ID: ${userId}`;
                        // åŒ¿åç™»å…¥æˆ–ç™»å‡ºå¾Œï¼Œä»è¨­å®šç›£è½å™¨ï¼Œä½†è³‡æ–™å°‡å„²å­˜åœ¨åŒ¿å ID ä¸‹
                        setupDataListener(userId); 
                        loadingSpinner.classList.add('hidden');
                        document.getElementById('input-form').classList.remove('hidden');
                    }
                });

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–æˆ–é©—è­‰å¤±æ•—:", error);
                currentUserIdDisplay.textContent = "ç„¡æ³•é€£æ¥æœå‹™";
                loadingSpinner.classList.add('hidden');
            }
        };

        // è¨ˆç®—ä¸¦æ¸²æŸ“æ‘˜è¦çµæœ
        const renderSummary = (readings) => {
            let totalSystolic = 0;
            let totalDiastolic = 0;
            let totalPulse = 0;
            let count = readings.length;
            
            if (count === 0) {
                summaryCard.innerHTML = `
                    <p class="text-gray-500 text-center py-4">ç›®å‰ç„¡ç´€éŒ„ï¼Œè«‹é–‹å§‹ç›£æ¸¬ã€‚</p>
                `;
                return;
            }

            // æŒ‰æ™‚é–“é»åˆ†çµ„ï¼Œåªé¡¯ç¤ºç•¶æ—¥æ•¸æ“šï¼Œæˆ–è€…æ‚¨å¯ä»¥é¸æ“‡å…¨éƒ¨æ•¸æ“š
            // é€™è£¡æˆ‘å€‘è¨ˆç®—æ‰€æœ‰ç´€éŒ„çš„ç¸½å¹³å‡
            readings.forEach(r => {
                totalSystolic += r.systolic;
                totalDiastolic += r.diastolic;
                totalPulse += r.pulse;
            });

            const avgSystolic = (totalSystolic / count).toFixed(0);
            const avgDiastolic = (totalDiastolic / count).toFixed(0);
            const avgPulse = (totalPulse / count).toFixed(0);
            
            summaryCard.innerHTML = `
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-2xl font-bold text-blue-600">${avgSystolic}/${avgDiastolic}</p>
                        <p class="text-sm text-gray-500">å¹³å‡è¡€å£“ (æ”¶ç¸®/èˆ’å¼µ)</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-green-600">${avgPulse}</p>
                        <p class="text-sm text-gray-500">å¹³å‡å¿ƒè·³ (æ¬¡/åˆ†)</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-yellow-600">${count}</p>
                        <p class="text-sm text-gray-500">ç¸½ç´€éŒ„ç­†æ•¸</p>
                    </div>
                </div>
            `;
        };

        // æ¸²æŸ“è®€æ•¸åˆ—è¡¨
        const renderReadings = (readings) => {
            readingsRef.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
            
            // ä¾æ™‚é–“æˆ³è¨˜æ’åº (æœ€è¿‘çš„åœ¨æœ€ä¸Šé¢)
            const sortedReadings = readings.sort((a, b) => {
                const timeA = a.timestamp?.seconds || 0;
                const timeB = b.timestamp?.seconds || 0;
                return timeB - timeA;
            });

            if (sortedReadings.length === 0) {
                readingsRef.innerHTML = `<p class="text-gray-500 text-center py-4">å°šç„¡ç›£æ¸¬ç´€éŒ„ã€‚</p>`;
                return;
            }

            sortedReadings.forEach(reading => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-white border-b border-gray-100 last:border-b-0 flex justify-between items-center rounded-lg my-2 card';

                const timestamp = reading.timestamp?.toDate ? reading.timestamp.toDate() : new Date();
                const timeString = timestamp.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                const dateString = timestamp.toLocaleDateString('zh-TW', { year: 'numeric', month: 'numeric', day: 'numeric' });

                li.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-semibold text-lg text-gray-800">${reading.timeSlot || 'æœªçŸ¥æ™‚æ®µ'} - ${timeString}</span>
                        <span class="text-xs text-gray-400">${dateString}</span>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-bold text-blue-700">${reading.systolic}/${reading.diastolic} mmHg</p>
                        <p class="text-sm text-green-600">å¿ƒè·³: ${reading.pulse} æ¬¡/åˆ†</p>
                    </div>
                `;
                readingsRef.appendChild(li);
            });
        };

        // ç›£è½ Firestore è³‡æ–™è®ŠåŒ–
        const setupDataListener = (uid) => {
            const path = getCollectionPath(uid);
            const q = query(collection(db, path));
            
            // å¯¦æ™‚ç›£è½
            onSnapshot(q, (snapshot) => {
                const readings = [];
                snapshot.forEach((doc) => {
                    readings.push({ id: doc.id, ...doc.data() });
                });
                
                // æ¸²æŸ“ UI
                renderReadings(readings);
                renderSummary(readings);

            }, (error) => {
                console.error("ç›£è½ Firestore è³‡æ–™å¤±æ•—:", error);
                readingsRef.innerHTML = `<p class="text-red-500 text-center py-4">è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚</p>`;
            });
        };

        // å„²å­˜æ–°çš„è®€æ•¸
        const saveReading = async (event) => {
            event.preventDefault();
            
            const form = event.target;
            const timeSlot = form.timeSlot.value;
            const systolic = parseInt(form.systolic.value);
            const diastolic = parseInt(form.diastolic.value);
            const pulse = parseInt(form.pulse.value);
            
            // åŸºæœ¬é©—è­‰
            if (!timeSlot || isNaN(systolic) || isNaN(diastolic) || isNaN(pulse)) {
                alert("è«‹ç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½å·²å¡«å¯«æ­£ç¢ºçš„æ•¸å€¼ã€‚");
                return;
            }

            if (systolic < 50 || diastolic < 30 || pulse < 30 || systolic > 300) {
                 alert("è«‹æª¢æŸ¥æ‚¨è¼¸å…¥çš„æ•¸å€¼æ˜¯å¦åˆç† (ä¾‹å¦‚ï¼šæ”¶ç¸®å£“ 50-300)ã€‚");
                 return;
            }

            try {
                const path = getCollectionPath(userId);
                await addDoc(collection(db, path), {
                    timestamp: serverTimestamp(),
                    timeSlot: timeSlot,
                    systolic: systolic,
                    diastolic: diastolic,
                    pulse: pulse,
                    userId: userId 
                });
                
                // æ¸…ç©ºæ•¸å€¼æ¬„ä½ï¼Œä»¥ä¾¿ä¸‹æ¬¡è¼¸å…¥
                form.systolic.value = '';
                form.diastolic.value = '';
                form.pulse.value = '';

                // å¯é¸ï¼šçµ¦äºˆæˆåŠŸæç¤º
                document.getElementById('success-message').classList.remove('opacity-0');
                setTimeout(() => {
                    document.getElementById('success-message').classList.add('opacity-0');
                }, 1500);

            } catch (error) {
                console.error("å„²å­˜è³‡æ–™å¤±æ•—:", error);
                alert("å„²å­˜è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        };

        // è¨­å®šè¡¨å–®æäº¤äº‹ä»¶
        window.onload = function() {
            initFirebase();
            document.getElementById('input-form').addEventListener('submit', saveReading);

            // è¨­å®šé è¨­æ™‚æ®µ
            const now = new Date();
            const hour = now.getHours();
            let defaultSlot = 'ç¡å‰';
            if (hour >= 5 && hour < 10) {
                defaultSlot = 'æ¸…æ™¨';
            } else if (hour >= 17 && hour < 20) {
                defaultSlot = 'å‚æ™š';
            }
            document.getElementById('time-slot-select').value = defaultSlot;
        }

    </script>
</head>
<body class="p-4 sm:p-6 min-h-screen">
    <div class="max-w-xl mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2">ğŸ©¸ å¥åº·ç›£æ¸¬æ—¥èªŒ</h1>
        <p id="current-user-id" class="text-sm text-gray-500 mb-4">æ­£åœ¨è¼‰å…¥ä½¿ç”¨è€… ID...</p>
        
        <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
        <div id="loading-spinner" class="text-center py-10">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-blue-600 mt-2">é€£ç·šè‡³è³‡æ–™åº«...</p>
        </div>

        <!-- æ•¸æ“šè¼¸å…¥å€å¡Š -->
        <div id="input-form" class="card bg-white p-6 mb-6 hidden">
            <h2 class="text-xl font-bold mb-4 text-gray-700">æ–°å¢ç›£æ¸¬ç´€éŒ„</h2>
            <form id="input-form">
                
                <!-- æ™‚æ®µé¸æ“‡ -->
                <div class="mb-4">
                    <label for="time-slot-select" class="block text-sm font-medium text-gray-700 mb-1">é¸æ“‡æ™‚æ®µ (ä¾å»ºè­°æ™‚é–“é»)</label>
                    <select id="time-slot-select" name="timeSlot" required class="focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- è«‹é¸æ“‡æ™‚æ®µ --</option>
                        <option value="æ¸…æ™¨">æ¸…æ™¨ (èµ·åºŠå¾Œ 1 å°æ™‚å…§)</option>
                        <option value="å‚æ™š">å‚æ™š (æ™šä¸Š 6-8 é»)</option>
                        <option value="ç¡å‰">ç¡å‰ (æº–å‚™å°±å¯¢å‰ 1 å°æ™‚)</option>
                        <option value="æœè—¥å¾Œ">æœè—¥å¾Œ (æœè—¥å¾Œç´„ 1 å°æ™‚)</option>
                    </select>
                </div>

                <!-- æ•¸å€¼è¼¸å…¥ -->
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div>
                        <label for="systolic" class="block text-sm font-medium text-gray-700 mb-1">æ”¶ç¸®å£“ (é«˜å£“)</label>
                        <input type="number" id="systolic" name="systolic" required min="50" max="300" placeholder="mmHg" class="focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="diastolic" class="block text-sm font-medium text-gray-700 mb-1">èˆ’å¼µå£“ (ä½å£“)</label>
                        <input type="number" id="diastolic" name="diastolic" required min="30" max="200" placeholder="mmHg" class="focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="pulse" class="block text-sm font-medium text-gray-700 mb-1">å¿ƒè·³ (è„ˆæ)</label>
                        <input type="number" id="pulse" name="pulse" required min="30" max="200" placeholder="æ¬¡/åˆ†" class="focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>

                <div class="relative">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl transition duration-150 shadow-lg">
                        å„²å­˜ç´€éŒ„
                    </button>
                    <!-- æˆåŠŸè¨Šæ¯ -->
                    <div id="success-message" class="absolute inset-0 flex items-center justify-center bg-green-500 text-white rounded-xl text-lg font-bold transition-opacity duration-300 opacity-0 pointer-events-none">
                        å„²å­˜æˆåŠŸ!
                    </div>
                </div>
            </form>
        </div>

        <!-- æ•¸æ“šæ‘˜è¦å€å¡Š -->
        <h2 class="text-xl font-bold mb-3 text-gray-700">æ•¸æ“šæ‘˜è¦ (æ‰€æœ‰ç´€éŒ„å¹³å‡)</h2>
        <div id="summary-card" class="card bg-white p-6 mb-6 text-center">
            <p class="text-gray-500 py-4">æ­£åœ¨è¨ˆç®—å¹³å‡å€¼...</p>
        </div>

        <!-- æ­·å²ç´€éŒ„å€å¡Š -->
        <h2 class="text-xl font-bold mb-3 text-gray-700">æ­·å²ç›£æ¸¬ç´€éŒ„ (æœ€æ–°)</h2>
        <ul id="readings-list" class="space-y-3">
            <li class="text-gray-500 text-center py-4">æ­£åœ¨è¼‰å…¥ç´€éŒ„...</li>
        </ul>
    </div>
</body>
</html>


